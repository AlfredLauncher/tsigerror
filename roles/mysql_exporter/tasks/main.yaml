---
 - name: Package
   apt:
     name: prometheus-mysqld-exporter
     force_apt_get: yes

 - name: Create directory
   file:
     path: /var/lib/prometheus
     state: directory

 - name: Config
   template:
     src: my.cnf.j2
     dest: /var/lib/prometheus/.my.cnf
     owner: prometheus
     group: prometheus
     mode: 0644
   notify:
     - restart mysql_exporter

 - name: Exporter MySQL user
   mysql_user:
     name: "exporter"
     password: "{{ mysql_exporter_pass }}"
     login_unix_socket: /var/run/mysqld/mysqld.sock
     priv: "*.*:PROCESS,REPLICATION CLIENT,SELECT"
   no_log: True

 - name: Enabled
   service:
     name: prometheus-mysqld-exporter
     state: started
     enabled: yes
